<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Ticker - Finance Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --muted: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --red: #f85149;
      --yellow: #d29922;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    header a {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
    }

    header a:hover { color: var(--accent); }

    header h1 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      flex: 1;
    }

    .search-bar {
      display: flex;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px 6px;
    }

    .search-bar input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-size: 15px;
      width: 160px;
      padding: 4px 6px;
      text-transform: uppercase;
    }

    .search-bar input::placeholder { color: var(--muted); text-transform: none; }

    .search-bar button {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      color: #0d1117;
      font-weight: 600;
      font-size: 14px;
      padding: 6px 16px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .search-bar button:hover { opacity: 0.85; }

    .quick-links {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .quick-links button {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--muted);
      font-size: 12px;
      padding: 4px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .quick-links button:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    main { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

    /* Loading / Error */
    .status-box {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .status-box .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .status-box.error { color: var(--red); }

    /* Hero row */
    .hero {
      display: flex;
      align-items: flex-start;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 24px;
    }

    .symbol-block h2 { font-size: 32px; font-weight: 700; }
    .symbol-block .company-name { color: var(--muted); font-size: 15px; margin-top: 2px; }
    .symbol-block .exchange { font-size: 12px; color: var(--muted); background: var(--surface2); border-radius: 4px; padding: 2px 7px; display: inline-block; margin-top: 6px; }

    .price-block { margin-left: auto; text-align: right; }
    .price-block .price { font-size: 36px; font-weight: 700; }
    .price-block .change { font-size: 16px; font-weight: 600; margin-top: 4px; }
    .price-block .change.pos { color: var(--green); }
    .price-block .change.neg { color: var(--red); }
    .price-block .timestamp { font-size: 12px; color: var(--muted); margin-top: 4px; }

    /* Stat cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
    }

    .stat-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
    .stat-card .value { font-size: 16px; font-weight: 600; }

    /* Technical indicators */
    .technicals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .tech-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
    }

    .tech-card .label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 6px; }
    .tech-card .value { font-size: 18px; font-weight: 700; }
    .tech-card .signal { font-size: 12px; margin-top: 4px; font-weight: 600; }
    .tech-card .signal.bullish { color: var(--green); }
    .tech-card .signal.bearish { color: var(--red); }
    .tech-card .signal.neutral { color: var(--yellow); }

    /* Section headers */
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      margin-bottom: 12px;
    }

    /* Chart container */
    .chart-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .chart-panel .chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chart-panel .chart-title { font-size: 15px; font-weight: 600; }

    .range-btns { display: flex; gap: 6px; }
    .range-btns button {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--muted);
      font-size: 12px;
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .range-btns button:hover, .range-btns button.active {
      background: var(--accent);
      border-color: var(--accent);
      color: #0d1117;
      font-weight: 600;
    }

    canvas { max-height: 320px; }

    /* Attribution */
    footer {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid var(--border);
      margin-top: 32px;
    }

    footer a { color: var(--accent); text-decoration: none; }

    @media (max-width: 600px) {
      header { flex-wrap: wrap; }
      .search-bar input { width: 120px; }
      .price-block { text-align: left; margin-left: 0; }
    }
  </style>
</head>
<body>

<header>
  <a href="index.html">&#8592; Portfolio</a>
  <h1>&#128200; Stock Ticker</h1>
  <div class="search-bar">
    <input type="text" id="symbolInput" placeholder="e.g. AAPL" maxlength="12" />
    <button onclick="loadTicker()">Search</button>
  </div>
</header>

<main>
  <div class="quick-links" style="margin-bottom:20px;">
    <span style="color:var(--muted);font-size:13px;align-self:center;">Quick:</span>
    <button onclick="setSymbol('AAPL')">AAPL</button>
    <button onclick="setSymbol('MSFT')">MSFT</button>
    <button onclick="setSymbol('GOOGL')">GOOGL</button>
    <button onclick="setSymbol('AMZN')">AMZN</button>
    <button onclick="setSymbol('TSLA')">TSLA</button>
    <button onclick="setSymbol('SPY')">SPY</button>
    <button onclick="setSymbol('QQQ')">QQQ</button>
    <button onclick="setSymbol('NVDA')">NVDA</button>
    <button onclick="setSymbol('JPM')">JPM</button>
    <button onclick="setSymbol('BTC-USD')">BTC</button>
  </div>

  <div id="content">
    <div class="status-box">
      <p>Enter a stock symbol above and click <strong>Search</strong>, or pick a quick link to get started.</p>
    </div>
  </div>
</main>

<footer>
  Data sourced from <a href="https://finance.yahoo.com" target="_blank" rel="noopener">Yahoo Finance</a> via public API &nbsp;&bull;&nbsp;
  For informational purposes only. Not financial advice.
</footer>

<script>
// ─── State ────────────────────────────────────────────────────────────────────
let allTimestamps = [];
let allCloses     = [];
let allVolumes    = [];
let allHighs      = [];
let allLows       = [];
let currentRange  = '1y';
let priceChart    = null;
let volumeChart   = null;
let currentSymbol = '';

// ─── Entry points ─────────────────────────────────────────────────────────────
function setSymbol(sym) {
  document.getElementById('symbolInput').value = sym;
  loadTicker();
}

function loadTicker() {
  const sym = document.getElementById('symbolInput').value.trim().toUpperCase();
  if (!sym) return;
  currentSymbol = sym;
  currentRange  = '1y';
  fetchData(sym, '1y');
}

// ─── Fetch ────────────────────────────────────────────────────────────────────
function fetchData(symbol, range) {
  showLoading();

  // Yahoo Finance chart endpoint via public CORS proxy
  const yUrl   = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=1d&range=${range}&corsDomain=finance.yahoo.com`;
  const proxy  = `https://corsproxy.io/?${encodeURIComponent(yUrl)}`;

  fetch(proxy)
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
    .then(data => {
      const result = data?.chart?.result?.[0];
      if (!result) throw new Error('Symbol not found or no data returned.');
      processData(result, range);
    })
    .catch(err => showError(err.message));
}

// ─── Process ──────────────────────────────────────────────────────────────────
function processData(result, range) {
  const meta   = result.meta;
  const ts     = result.timestamp || [];
  const quotes = result.indicators?.quote?.[0] || {};

  allTimestamps = ts;
  allCloses     = quotes.close  || [];
  allVolumes    = quotes.volume || [];
  allHighs      = quotes.high   || [];
  allLows       = quotes.low    || [];

  const labels = ts.map(t => {
    const d = new Date(t * 1000);
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
  });

  const closes = allCloses;
  const price  = meta.regularMarketPrice ?? closes[closes.length - 1];
  const prev   = meta.chartPreviousClose ?? meta.previousClose ?? closes[closes.length - 2];
  const change = price - prev;
  const changePct = (change / prev) * 100;

  // ── Technicals ──
  const sma20  = sma(closes, 20);
  const sma50  = sma(closes, 50);
  const ema20  = ema(closes, 20);
  const rsi14  = rsi(closes, 14);
  const macdRes = macd(closes, 12, 26, 9);
  const bbandsRes = bbands(closes, 20, 2);

  const lastSma20  = last(sma20);
  const lastSma50  = last(sma50);
  const lastEma20  = last(ema20);
  const lastRsi    = last(rsi14);
  const lastMacd   = last(macdRes.macdLine);
  const lastSignal = last(macdRes.signalLine);
  const lastBBUpper= last(bbandsRes.upper);
  const lastBBLower= last(bbandsRes.lower);

  renderPage({
    meta, price, change, changePct, closes, labels,
    sma20, sma50, ema20,
    lastSma20, lastSma50, lastEma20, lastRsi,
    lastMacd, lastSignal, lastBBUpper, lastBBLower,
    macdRes, bbandsRes
  });
}

// ─── Render ───────────────────────────────────────────────────────────────────
function renderPage(d) {
  const { meta, price, change, changePct, closes, labels,
    lastSma20, lastSma50, lastEma20, lastRsi,
    lastMacd, lastSignal, lastBBUpper, lastBBLower,
    sma20, sma50, ema20, macdRes } = d;

  const posNeg = change >= 0;
  const vol    = meta.regularMarketVolume ?? allVolumes[allVolumes.length - 1] ?? 0;
  const cap    = meta.marketCap;
  const week52H = meta['52WeekHigh'] ?? meta.fiftyTwoWeekHigh;
  const week52L = meta['52WeekLow']  ?? meta.fiftyTwoWeekLow;

  // RSI signal
  let rsiSignal = 'neutral', rsiText = 'Neutral';
  if (lastRsi > 70)      { rsiSignal = 'bearish'; rsiText = 'Overbought'; }
  else if (lastRsi < 30) { rsiSignal = 'bullish';  rsiText = 'Oversold'; }

  // MACD signal
  const macdSignalClass = lastMacd > lastSignal ? 'bullish' : 'bearish';
  const macdSignalText  = lastMacd > lastSignal ? 'Bullish cross' : 'Bearish cross';

  // Price vs MA signals
  const vsSma20 = price > lastSma20 ? 'bullish' : 'bearish';
  const vsSma50 = price > lastSma50 ? 'bullish' : 'bearish';

  document.getElementById('content').innerHTML = `
    <div class="hero">
      <div class="symbol-block">
        <h2>${meta.symbol ?? currentSymbol}</h2>
        <div class="company-name">${meta.longName ?? meta.shortName ?? ''}</div>
        <span class="exchange">${meta.exchangeName ?? meta.fullExchangeName ?? ''} &bull; ${meta.currency ?? 'USD'}</span>
      </div>
      <div class="price-block">
        <div class="price">$${fmtPrice(price)}</div>
        <div class="change ${posNeg ? 'pos' : 'neg'}">
          ${posNeg ? '▲' : '▼'} ${fmtPrice(Math.abs(change))} (${fmtPrice(Math.abs(changePct))}%)
        </div>
        <div class="timestamp">Last updated: ${new Date().toLocaleTimeString()}</div>
      </div>
    </div>

    <p class="section-title">Market Data</p>
    <div class="stats-grid">
      <div class="stat-card"><div class="label">Volume</div><div class="value">${fmtNum(vol)}</div></div>
      <div class="stat-card"><div class="label">Market Cap</div><div class="value">${cap ? fmtMarketCap(cap) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">52W High</div><div class="value">${week52H ? '$'+fmtPrice(week52H) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">52W Low</div><div class="value">${week52L ? '$'+fmtPrice(week52L) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">Day High</div><div class="value">${meta.regularMarketDayHigh ? '$'+fmtPrice(meta.regularMarketDayHigh) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">Day Low</div><div class="value">${meta.regularMarketDayLow ? '$'+fmtPrice(meta.regularMarketDayLow) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">Prev Close</div><div class="value">${meta.chartPreviousClose ? '$'+fmtPrice(meta.chartPreviousClose) : 'N/A'}</div></div>
      <div class="stat-card"><div class="label">Open</div><div class="value">${meta.regularMarketOpen ? '$'+fmtPrice(meta.regularMarketOpen) : 'N/A'}</div></div>
    </div>

    <p class="section-title">Technical Indicators</p>
    <div class="technicals-grid">
      <div class="tech-card">
        <div class="label">SMA (20)</div>
        <div class="value">$${fmtPrice(lastSma20)}</div>
        <div class="signal ${vsSma20}">${price > lastSma20 ? 'Price above SMA20' : 'Price below SMA20'}</div>
      </div>
      <div class="tech-card">
        <div class="label">SMA (50)</div>
        <div class="value">$${fmtPrice(lastSma50)}</div>
        <div class="signal ${vsSma50}">${price > lastSma50 ? 'Price above SMA50' : 'Price below SMA50'}</div>
      </div>
      <div class="tech-card">
        <div class="label">EMA (20)</div>
        <div class="value">$${fmtPrice(lastEma20)}</div>
        <div class="signal ${price > lastEma20 ? 'bullish' : 'bearish'}">${price > lastEma20 ? 'Price above EMA20' : 'Price below EMA20'}</div>
      </div>
      <div class="tech-card">
        <div class="label">RSI (14)</div>
        <div class="value">${fmtPrice(lastRsi)}</div>
        <div class="signal ${rsiSignal}">${rsiText}</div>
      </div>
      <div class="tech-card">
        <div class="label">MACD (12,26,9)</div>
        <div class="value">${fmtPrice(lastMacd)}</div>
        <div class="signal ${macdSignalClass}">${macdSignalText}</div>
      </div>
      <div class="tech-card">
        <div class="label">BB Upper (20,2)</div>
        <div class="value">$${fmtPrice(lastBBUpper)}</div>
        <div class="signal ${price > lastBBUpper ? 'bearish' : 'neutral'}">${price > lastBBUpper ? 'Above upper band' : 'Within bands'}</div>
      </div>
      <div class="tech-card">
        <div class="label">BB Lower (20,2)</div>
        <div class="value">$${fmtPrice(lastBBLower)}</div>
        <div class="signal ${price < lastBBLower ? 'bullish' : 'neutral'}">${price < lastBBLower ? 'Below lower band' : 'Within bands'}</div>
      </div>
    </div>

    <div class="chart-panel">
      <div class="chart-header">
        <span class="chart-title">Price History with Moving Averages</span>
        <div class="range-btns">
          <button onclick="changeRange('1mo')" ${currentRange==='1mo'?'class="active"':''}>1M</button>
          <button onclick="changeRange('3mo')" ${currentRange==='3mo'?'class="active"':''}>3M</button>
          <button onclick="changeRange('6mo')" ${currentRange==='6mo'?'class="active"':''}>6M</button>
          <button onclick="changeRange('1y')"  ${currentRange==='1y' ?'class="active"':''}>1Y</button>
          <button onclick="changeRange('2y')"  ${currentRange==='2y' ?'class="active"':''}>2Y</button>
          <button onclick="changeRange('5y')"  ${currentRange==='5y' ?'class="active"':''}>5Y</button>
        </div>
      </div>
      <canvas id="priceChart"></canvas>
    </div>

    <div class="chart-panel">
      <div class="chart-header">
        <span class="chart-title">Volume</span>
      </div>
      <canvas id="volumeChart"></canvas>
    </div>

    <div class="chart-panel">
      <div class="chart-header">
        <span class="chart-title">RSI (14)</span>
      </div>
      <canvas id="rsiChart"></canvas>
    </div>

    <div class="chart-panel">
      <div class="chart-header">
        <span class="chart-title">MACD (12, 26, 9)</span>
      </div>
      <canvas id="macdChart"></canvas>
    </div>
  `;

  buildPriceChart(labels, closes, sma20, sma50, ema20);
  buildVolumeChart(labels, allVolumes);
  buildRsiChart(labels, rsi(closes, 14));
  buildMacdChart(labels, macdRes);
}

function changeRange(range) {
  currentRange = range;
  fetchData(currentSymbol, range);
}

// ─── Chart builders ───────────────────────────────────────────────────────────
function buildPriceChart(labels, closes, sma20Data, sma50Data, ema20Data) {
  if (priceChart) { priceChart.destroy(); }
  const ctx = document.getElementById('priceChart').getContext('2d');
  priceChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Close',
          data: closes,
          borderColor: '#58a6ff',
          backgroundColor: 'rgba(88,166,255,0.08)',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1,
          fill: true,
        },
        {
          label: 'SMA 20',
          data: sma20Data,
          borderColor: '#f0883e',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.1,
        },
        {
          label: 'SMA 50',
          data: sma50Data,
          borderColor: '#3fb950',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.1,
        },
        {
          label: 'EMA 20',
          data: ema20Data,
          borderColor: '#bc8cff',
          borderWidth: 1.5,
          pointRadius: 0,
          borderDash: [4, 3],
          tension: 0.1,
        },
      ]
    },
    options: chartOptions('Price (USD)')
  });
}

function buildVolumeChart(labels, volumes) {
  if (volumeChart) { volumeChart.destroy(); }
  const ctx = document.getElementById('volumeChart').getContext('2d');
  volumeChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Volume',
        data: volumes,
        backgroundColor: 'rgba(88,166,255,0.5)',
        borderWidth: 0,
      }]
    },
    options: chartOptions('Volume')
  });
}

function buildRsiChart(labels, rsiData) {
  const ctx = document.getElementById('rsiChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'RSI 14',
          data: rsiData,
          borderColor: '#d29922',
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.1,
        },
        {
          label: 'Overbought (70)',
          data: Array(labels.length).fill(70),
          borderColor: 'rgba(248,81,73,0.5)',
          borderWidth: 1,
          borderDash: [5, 4],
          pointRadius: 0,
        },
        {
          label: 'Oversold (30)',
          data: Array(labels.length).fill(30),
          borderColor: 'rgba(63,185,80,0.5)',
          borderWidth: 1,
          borderDash: [5, 4],
          pointRadius: 0,
        },
      ]
    },
    options: {
      ...chartOptions('RSI'),
      scales: {
        x: xScale(),
        y: { ...yScaleBase(), min: 0, max: 100, ticks: { color: '#8b949e', stepSize: 10 } }
      }
    }
  });
}

function buildMacdChart(labels, macdRes) {
  const ctx = document.getElementById('macdChart').getContext('2d');
  const hist = macdRes.histogram;
  const histColors = hist.map(v => v == null ? 'transparent' : v >= 0 ? 'rgba(63,185,80,0.7)' : 'rgba(248,81,73,0.7)');

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'MACD',
          data: macdRes.macdLine,
          type: 'line',
          borderColor: '#58a6ff',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.1,
          yAxisID: 'y',
        },
        {
          label: 'Signal',
          data: macdRes.signalLine,
          type: 'line',
          borderColor: '#f0883e',
          borderWidth: 1.5,
          pointRadius: 0,
          tension: 0.1,
          yAxisID: 'y',
        },
        {
          label: 'Histogram',
          data: hist,
          backgroundColor: histColors,
          borderWidth: 0,
          yAxisID: 'y',
        }
      ]
    },
    options: chartOptions('MACD')
  });
}

// ─── Chart helpers ────────────────────────────────────────────────────────────
function xScale() {
  return {
    ticks: {
      color: '#8b949e',
      maxTicksLimit: 8,
      maxRotation: 0,
    },
    grid: { color: 'rgba(48,54,61,0.6)' }
  };
}

function yScaleBase() {
  return {
    ticks: { color: '#8b949e' },
    grid: { color: 'rgba(48,54,61,0.6)' }
  };
}

function chartOptions(yLabel) {
  return {
    responsive: true,
    interaction: { mode: 'index', intersect: false },
    plugins: {
      legend: { labels: { color: '#8b949e', boxWidth: 14, font: { size: 12 } } },
      tooltip: {
        backgroundColor: '#21262d',
        titleColor: '#e6edf3',
        bodyColor: '#8b949e',
        borderColor: '#30363d',
        borderWidth: 1,
      }
    },
    scales: {
      x: xScale(),
      y: { ...yScaleBase(), title: { display: true, text: yLabel, color: '#8b949e', font: { size: 11 } } }
    }
  };
}

// ─── Technical Indicator Math ─────────────────────────────────────────────────
function sma(data, period) {
  return data.map((_, i) => {
    if (i < period - 1) return null;
    const slice = data.slice(i - period + 1, i + 1);
    if (slice.some(v => v == null)) return null;
    return slice.reduce((a, b) => a + b, 0) / period;
  });
}

function ema(data, period) {
  const k = 2 / (period + 1);
  const result = Array(data.length).fill(null);
  let started = false;
  let prev = 0;

  for (let i = 0; i < data.length; i++) {
    if (data[i] == null) continue;
    if (!started) {
      if (i >= period - 1) {
        const slice = data.slice(i - period + 1, i + 1);
        if (slice.every(v => v != null)) {
          prev = slice.reduce((a, b) => a + b, 0) / period;
          result[i] = prev;
          started = true;
        }
      }
    } else {
      prev = data[i] * k + prev * (1 - k);
      result[i] = prev;
    }
  }
  return result;
}

function rsi(data, period) {
  const result = Array(data.length).fill(null);
  if (data.length < period + 1) return result;

  let gains = 0, losses = 0;
  for (let i = 1; i <= period; i++) {
    if (data[i] == null || data[i-1] == null) continue;
    const diff = data[i] - data[i - 1];
    if (diff >= 0) gains += diff; else losses -= diff;
  }
  let avgGain  = gains  / period;
  let avgLoss  = losses / period;
  result[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));

  for (let i = period + 1; i < data.length; i++) {
    if (data[i] == null || data[i-1] == null) continue;
    const diff = data[i] - data[i - 1];
    const gain = diff > 0 ? diff : 0;
    const loss = diff < 0 ? -diff : 0;
    avgGain = (avgGain * (period - 1) + gain)  / period;
    avgLoss = (avgLoss * (period - 1) + loss) / period;
    result[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + avgGain / avgLoss));
  }
  return result;
}

function macd(data, fast, slow, signal) {
  const fastEma   = ema(data, fast);
  const slowEma   = ema(data, slow);
  const macdLine  = fastEma.map((v, i) => (v != null && slowEma[i] != null) ? v - slowEma[i] : null);
  const signalLine = ema(macdLine.map(v => v ?? 0), signal).map((v, i) => macdLine[i] != null ? v : null);
  const histogram  = macdLine.map((v, i) => (v != null && signalLine[i] != null) ? v - signalLine[i] : null);
  return { macdLine, signalLine, histogram };
}

function bbands(data, period, stdDev) {
  const mid   = sma(data, period);
  const upper = mid.map((m, i) => {
    if (m == null) return null;
    const slice = data.slice(i - period + 1, i + 1);
    const sd = Math.sqrt(slice.reduce((s, v) => s + (v - m) ** 2, 0) / period);
    return m + stdDev * sd;
  });
  const lower = mid.map((m, i) => {
    if (m == null) return null;
    const slice = data.slice(i - period + 1, i + 1);
    const sd = Math.sqrt(slice.reduce((s, v) => s + (v - m) ** 2, 0) / period);
    return m - stdDev * sd;
  });
  return { upper, mid, lower };
}

function last(arr) {
  for (let i = arr.length - 1; i >= 0; i--) {
    if (arr[i] != null) return arr[i];
  }
  return 0;
}

// ─── Formatting ───────────────────────────────────────────────────────────────
function fmtPrice(n) {
  if (n == null || isNaN(n)) return 'N/A';
  return n.toFixed(2);
}

function fmtNum(n) {
  if (n == null) return 'N/A';
  if (n >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(2) + 'K';
  return n.toString();
}

function fmtMarketCap(n) {
  if (n >= 1e12) return '$' + (n / 1e12).toFixed(2) + 'T';
  if (n >= 1e9)  return '$' + (n / 1e9).toFixed(2)  + 'B';
  if (n >= 1e6)  return '$' + (n / 1e6).toFixed(2)  + 'M';
  return '$' + n;
}

// ─── UI helpers ───────────────────────────────────────────────────────────────
function showLoading() {
  document.getElementById('content').innerHTML = `
    <div class="status-box">
      <div class="spinner"></div>
      <p>Fetching data from Yahoo Finance…</p>
    </div>`;
}

function showError(msg) {
  document.getElementById('content').innerHTML = `
    <div class="status-box error">
      <p>&#9888; ${msg}</p>
      <p style="margin-top:10px;font-size:13px;color:var(--muted)">
        Check the symbol and try again. Examples: AAPL, MSFT, BTC-USD, ^GSPC
      </p>
    </div>`;
}

// ─── Keyboard shortcut ────────────────────────────────────────────────────────
document.getElementById('symbolInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') loadTicker();
});
</script>
</body>
</html>
